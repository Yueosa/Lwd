# UI 使用手册

本文档详细说明 Lwd 界面中每一个面板、按钮、输入框和交互操作。

---

## 目录

- [主窗口布局](#主窗口布局)
- [启动画面（Splash）](#启动画面splash)
- [控制面板（左侧）](#控制面板左侧)
  - [世界尺寸](#世界尺寸)
  - [种子](#种子)
  - [生成进度](#生成进度)
  - [步进控制](#步进控制)
  - [步骤列表](#步骤列表)
  - [生成操作](#生成操作)
  - [导出 / 导入](#导出--导入)
  - [缩放](#缩放)
  - [配置入口](#配置入口)
- [世界画布](#世界画布)
  - [鼠标操作](#鼠标操作)
  - [可视化覆盖层](#可视化覆盖层)
  - [小地图（Minimap）](#小地图minimap)
- [弹出窗口](#弹出窗口)
  - [可视化配置](#可视化配置)
  - [层级配置](#层级配置)
  - [算法参数](#算法参数)
  - [几何预览](#几何预览)
  - [图形 API 沙箱](#图形-api-沙箱)
  - [性能面板](#性能面板)
- [底部状态栏](#底部状态栏)
- [文件对话框](#文件对话框)
- [主题与配色](#主题与配色)
- [默认值速查](#默认值速查)

---

## 主窗口布局

窗口分三个区域：

| 区域 | 位置 | 大小 |
|------|------|------|
| 控制面板 | 左侧 | 默认宽 260px，可拖拽调整 |
| 世界画布 | 中央 | 占满剩余空间 |
| 状态栏 | 底部 | 固定 28px |

启动时从 `runtime.json` 自动恢复上次保存的 UI 状态（世界尺寸、覆盖层开关等）。

---

## 启动画面（Splash）

在执行任何生成操作之前，中央区域显示大字 ASCII 艺术 `LIANWORLD`（粉→蓝渐变），下方闪烁提示：

> < 在左侧面板点击 \[重新初始化\] 开始 >

点击 **重新初始化** 或 **一键生成** 后，Splash 消失，切换为世界画布。

---

## 控制面板（左侧）

面板内设有垂直滚动条。从上到下排列如下各区域：

### 世界尺寸

标签 `◈ 世界尺寸`。四个单选项：

| 选项 | 说明 |
|------|------|
| 小型 (4200×1200) | 默认 |
| 中型 (6400×1800) | — |
| 大型 (8400×2400) | — |
| 自定义 | 显示宽/高输入框 |

> 尺寸数值从 `world.json` 配置读取，非硬编码。

选择 **自定义** 后出现两个文本框：

- **宽:** 占位提示 `4200`，宽度 60px
- **× 高:** 占位提示 `1200`，宽度 60px

切换世界尺寸会根据当前进度自动重置或重新生成。

### 种子

标签 `◈ 种子`。

- 文本输入框：占位提示 `输入种子 (十六进制/十进制)`，宽度 140px
- **OK** 按钮：应用种子并重置到第 0 步
- 输入框内按 **Enter** 等效于点击 OK

> 这是全局唯一的键盘快捷键。

### 生成进度

标签 `◈ 生成进度`。

- 粉→蓝渐变进度条，高 18px，显示百分比数字
- 下方灰色小字：`子步骤: {已执行}/{总数}`

### 步进控制

标签 `◈ 步进控制`。四个按钮横向排列：

| 按钮 | 功能 | 启用条件 |
|------|------|----------|
| ⏮ | 大步后退（回退到当前阶段开头） | 已执行步数 > 0 |
| ◂ | 小步后退（回退一个子步骤） | 已执行步数 > 0 |
| ▸ | 小步前进（执行下一个子步骤） | 未到最后一步 |
| ⏭ | 大步前进（执行完当前阶段全部子步骤） | 未到最后一步 |

> 回退通过重置+重放实现，因此后期回退中可能需要短暂时间。

### 步骤列表

标签 `◈ 步骤列表`。可滚动区域（高度约占面板 35%），展示当前管线的所有阶段和子步骤。

**阶段符号：**

| 符号 | 颜色 | 含义 |
|------|------|------|
| ● | 粉色 | 已完成 |
| ◆ | 蓝色 | 当前执行中 |
| ○ | 灰色 | 待执行 |

**子步骤符号（缩进显示）：**

| 符号 | 颜色 | 含义 |
|------|------|------|
| ✦ | 深粉 | 已完成 |
| ▸ | 浅蓝 | 当前 |
| · | 灰色 | 待执行 |

鼠标悬浮在阶段上显示阶段描述；悬浮在子步骤上显示子步骤描述，若有文档链接还会显示 `[Doc] 查看算法文档`。

### 生成操作

标签 `◈ 生成操作`。

| 按钮 | 功能 |
|------|------|
| ✦ 一键生成 | 随机新种子 → 重置 → 执行全部步骤 |
| ↻ 重新初始化 | 随机新种子 → 重置到第 0 步（不执行） |
| ▶▶ 执行到底 | 从当前步骤逐帧增量执行到最后（仅在未完成时可用） |
| ≡ 算法参数 | 打开当前步骤的参数配置窗口 |
| 📐 几何预览 | 查看当前步骤使用的几何图形 |
| ◈ 图形 API 沙箱 | 创建新的沙箱窗口（支持多实例） |

### 导出 / 导入

标签 `◈ 导出 / 导入`。

| 按钮 | 功能 |
|------|------|
| ▣ 导出 PNG | 将当前世界 1:1 导出为 PNG 图片 |
| □ 导出 .lwd | 保存世界快照（包含种子、参数，不含方块数据） |
| ■ 导入 .lwd | 从快照文件恢复世界并自动重放 |

### 缩放

标签 `◈ 缩放`。

| 按钮 | 功能 |
|------|------|
| ＋ | 放大 |
| － | 缩小 |
| ↺ 重置 | 恢复默认缩放 |

> 画布上使用鼠标滚轮缩放更加方便（以光标为锚点）。

### 配置入口

标签 `◈ 配置`。

| 按钮 | 打开窗口 |
|------|----------|
| ◉ 可视化 | 环境/层级覆盖层开关 |
| ▧ 层级 | 层级垂直分布编辑器 |
| ⚙ 性能 | 引擎调优参数和生成日志 |

面板底部显示当前状态概要：

- `缩放: {n}%`
- `方块数: {n}`（已加载方块种类）
- `尺寸: {w} × {h}`

---

## 世界画布

### 鼠标操作

| 操作 | 行为 |
|------|------|
| 拖拽 | 平移画布 |
| 滚轮 | 以鼠标位置为锚点缩放（每次 ±10%，总范围 0.05×\~20×） |
| 悬浮 | 状态栏显示悬浮方块信息 |

悬浮信息格式：`{方块名}(ID:{id}) @ ({x}, {y}) | {环境名}·{层名}`

### 可视化覆盖层

四种覆盖层可通过 **可视化配置** 窗口独立开关：

| 覆盖层 | 默认 | 说明 |
|--------|------|------|
| 环境覆盖色 | 关 | 半透明彩色着色，每种环境一个颜色 |
| 环境文字标签 | 关 | 在可见区域自适应采样放置环境名称，自动避让重叠 |
| 层级分界线 | 开 | 白色半透明水平线标记层级边界 |
| 层级文字标签 | 开 | 在每层垂直中心位置显示层级名称 |

环境标签使用自适应步长扫描：缩放 < 0.4 时步长 48px，< 0.8 时 32px，其他 16px。最多显示 32 个标签，大面积区域优先。

### 小地图（Minimap）

固定在画布右下角，最大 180×110px，始终保持世界宽高比。深色半透明背景上显示世界缩略图，蓝色矩形标记当前可见区域。

---

## 弹出窗口

### 可视化配置

窗口标题 `👁 可视化配置`，固定宽度 240px。

四个复选框分为两组：

**环境 (Biome)：**
- ☐ 显示环境覆盖色
- ☐ 显示环境文字标签

**层级 (Layer)：**
- ☑ 显示层级分界线
- ☑ 显示层级文字标签

底部两个快捷按钮：**全部开启** / **全部关闭**。

### 层级配置

窗口标题 `🗺 层级配置`，默认宽度 500px。

**配置模式：** 两个单选项
- **百分比** — 以世界高度的百分比编辑各层边界（默认）
- **具体高度（行数）** — 以像素行数编辑

**配置表格：** 表格以斑马条纹显示所有层级（如太空、地表、地下、洞穴、地狱），每层有可拖拽的起始/结束数值控件。

**智能联动：** 修改一层的结束值时，下一层的起始值自动同步。

**底部按钮：**
- 🔄 恢复默认 — 从 `world.json` 重读默认值
- 💾 保存配置 — 写入 `runtime.json`
- ✖ 关闭

### 算法参数

窗口标题 `⚙ {算法名} — 参数配置`，默认宽度 360px。

参数列表完全从算法的 `meta()` 接口自动生成：

| 参数类型 | 生成控件 |
|----------|----------|
| Float | 浮点数滑块 |
| Int | 整数滑块 |
| Bool | 复选框 |
| Text | 文本输入框 |
| Enum | 下拉菜单 |

参数按 `group` 字段自动分组为可折叠区域。每个参数名旁有 ℹ 图标，悬浮显示说明文字。

**底部按钮：**
- 🔄 重新执行当前步骤 — 使用修改后的参数从当前阶段开头重新执行
- 重置为默认值

### 几何预览

窗口标题 `📐 几何预览 — {步骤名}`，默认 480×520px。

上半部分为 mini 画布（260px 高），在深色背景上绘制世界边框和 25%/50%/75% 参考网格，并叠加该步骤记录的所有几何形状。选中的形状高亮为黄色。

鼠标操作与主画布相同（拖拽平移、滚轮缩放、点击选择形状）。

中间为 **形状列表**（最高 200px，可滚动），每行显示可见性开关、颜色方块和形状名称/类型。

下方为选中形状的 **详情面板**，显示：类型、数学描述、包围盒坐标和尺寸，以及各形状特有的参数。

### 图形 API 沙箱

窗口标题 `◈ {标题} — 图形 API 沙箱`，默认 600×640px，**支持多实例**。

这是一个交互式几何图形创建与组合的工具。

#### 顶部工具栏

- **添加形状：** 从下拉菜单选择类型（矩形/椭圆/梯形/列），点击 ➕ 创建
- **显示模式：** 基础 / 组合 / 全部（默认全部）
- **精度：** 低(快) / 中 / 高 / 极高(慢)，影响集合运算的像素采样密度
- **⟳ 复位：** 重置画布视角

#### 左侧面板

**基础形状列表：** 每行含颜色方块、可见性开关、名称标签和 ✕ 删除按钮。

**集合运算列表：** 需要至少 2 个基础形状。通过选择 左操作数 + 运算符（∪ 并集 / ∩ 交集 / − 差集）+ 右操作数，点击 ➕ 创建组合。

#### 右侧画布

在深色背景上绘制世界边框和参考网格。基础形状以循环色板着色，选中时黄色高亮。

鼠标操作：拖拽平移、滚轮缩放（0.1×\~20×）、点击选择形状。悬浮时在 tooltip 显示世界坐标 `({x}, {y})`。

#### 详情面板

选中基础形状时显示：标签编辑框、参数编辑控件（DragValue）、数学描述和 **Rust 代码片段**（附 📋 复制按钮）。

选中组合时显示：运算信息和对应的多行 Rust 代码（附 📋 复制代码 按钮）。

> 代码片段可直接粘贴到自定义算法中使用。

### 性能面板

窗口标题 `⚙ 性能面板`，默认 480×560px。

#### 引擎参数

| 参数 | 控件类型 | 范围 |
|------|----------|------|
| 并行像素阈值 | 对数滑块 | 5,000 \~ 500,000 px |
| 初始 Batch | 数值微调 | 1 \~ 64 |
| 目标帧时间下限 (ms) | 数值微调 | 1 \~ 50 |
| 目标帧时间上限 (ms) | 数值微调 | 1 \~ 100 |
| Batch 范围（最小/最大） | 数值微调 | 1\~32 / 1\~256 |
| EMA 平滑系数 | 滑块 | 0.05 \~ 0.9 |
| 小世界阈值 (px) | 数值微调 | 100,000 \~ 10,000,000 |
| 大世界阈值 (px) | 数值微调 | 100,000 \~ 50,000,000 |
| 刷新间隔（小/中/大） | 数值微调 ×3 | 1 \~ 32 |
| 日志最大保留数 | 数值微调 | 1 \~ 1000 |

**按钮：**
- **重新校准** — 运行微基准测试自动确定最优参数
- **恢复默认** — 恢复所有引擎参数

#### 当前生成性能

显示本次生成的总耗时和每个步骤的平均/最大耗时明细表。

#### 历史日志

表格显示最近的生成记录（最多 20 条），每行包含时间、世界尺寸和总耗时。

---

## 底部状态栏

固定高度 28px，横向排列以下信息（竖线分隔）：

| 字段 | 格式示例 |
|------|----------|
| 状态消息 | `状态: 世界初始化完成` |
| 悬浮信息 | `泥土(ID:1) @ (100, 200) \| 森林·地表` |
| 步进进度 | `Step 3 (5/18)` 或 `已完成 (18/18)` |
| 世界尺寸 | `4200×1200` |
| 种子 | `Seed: a1b2c3d4e5f67890` |
| 帧率 | `FPS: 60` |
| 内存 | `内存: ~42MB` |

---

## 文件对话框

三种文件对话框均使用系统原生对话框（rfd 库）：

| 操作 | 对话框标题 | 默认文件名 | 文件过滤器 |
|------|------------|------------|------------|
| 导出 PNG | 导出 PNG | `world_export.png` | PNG 图片 (*.png) |
| 导出 .lwd | 导出世界存档 | `world_export.lwd` | Lian World 存档 (*.lwd) |
| 导入 .lwd | 导入世界存档 | — | Lian World 存档 (*.lwd) |

---

## 主题与配色

Lwd 使用粉蓝白暗色主题（灵感来自跨性别旗帜配色）。

**主色调：**

| 名称 | 色值 | 用途 |
|------|------|------|
| Pink | rgb(245, 169, 184) | 主强调色、已完成标记 |
| Blue | rgb(91, 206, 250) | 次强调色、当前标记 |
| White | rgb(255, 255, 255) | 文字、高亮 |

**界面基底：** 深灰蓝色调（背景 rgb(30,30,40)、面板 rgb(38,38,52)、控件 rgb(50,50,68)）。

**进度条：** 从粉色平滑渐变到蓝色（0% → 100%）。

---

## 默认值速查

| 项目 | 默认值 |
|------|--------|
| 世界尺寸 | 小型（从 runtime.json 恢复上次选择） |
| 种子 | 随机 u64 |
| 环境覆盖色 | 关 |
| 环境文字标签 | 关 |
| 层级分界线 | 开 |
| 层级文字标签 | 开 |
| 缩放 | 100% |
| 画布缩放范围 | 0.05× \~ 20× |
| 几何预览缩放范围 | 0.2× \~ 10× |
| 沙箱画布缩放范围 | 0.1× \~ 20× |
| 层级配置模式 | 百分比 |
| 沙箱显示模式 | 全部 |
| 沙箱组合精度 | 中 |
